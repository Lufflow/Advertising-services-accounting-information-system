{% extends 'base.html' %}

{% block title %}
Редактирование заказа
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Редактирование заказа #{{ order.id }}</h1>
    <form method="POST">
        <div class="row">
            <!-- Первая колонка: форма выбора -->
            <div class="col-md-5">
                <div class="card" id="form_card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Изменение клиента и услуги</h5>
                    </div>
                    <div class="card-body">
                        <!-- Выбор клиента -->
                        <div class="mb-3">
                            <label for="customer_id" class="form-label">Выберите клиента *</label>
                            <select class="form-select" id="customer_id" name="customer_id" required>
                                <option value="">---</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}" 
                                    {% if order.customer_id == customer.id %}selected{% endif %}>
                                    {{ customer.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Выбор услуги -->
                        <div class="mb-3">
                            <label for="service_id" class="form-label">Выберите услугу *</label>
                            <select class="form-select" id="service_id" name="service_id" required>
                                <option value="">---</option>
                                {% for service in services %}
                                <option value="{{ service.id }}"
                                    {% if order.service_id == service.id %}selected{% endif %}>
                                    {{ service.service_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Дата оформления -->
                        <div class="mb-3">
                            <label for="order_date" class="form-label">Дата оформления</label>
                            <input type="date" class="form-control" id="order_date" name="order_date" 
                                   value="{{ order.order_date.strftime('%Y-%m-%d') }}">
                            <div class="form-text">Дата заказа</div>
                        </div>

                        <!-- Кнопки отправки -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-success btn-lg w-100 mb-2">Обновить заказ</button>
                            <a href="{{ url_for('list_orders') }}" class="btn btn-secondary btn-lg w-100">Отмена</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вторая колонка: информация о клиенте и услуге -->
            <div class="col-md-7">
                <!-- Карточка клиента -->
                <div class="card mb-4" id="customer_card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Информация о клиенте</h5>
                    </div>
                    <div class="card-body">
                        <div id="customer-info">
                            <h6 id="customer-name" class="card-subtitle mb-2">{{ order.customer.name }}</h6>
                            <p class="card-text mb-1"><b>Телефон:</b> <span id="customer-phone">{{ order.customer.phone_number }}</span></p>
                            <p class="card-text mb-1"><b>Email:</b> <span id="customer-email">{{ order.customer.email or 'Не указан' }}</span></p>
                            <p class="card-text mb-1"><b>Компания:</b> <span id="customer-company">{{ order.customer.company or 'Не указана' }}</span></p>
                            <p class="card-text"><b>Дата рождения:</b> <span id="customer-birthdate">
                                {% if order.customer.date_of_birth %}
                                    {{ order.customer.date_of_birth.strftime('%d.%m.%Y') }}
                                {% else %}
                                    Не указана
                                {% endif %}
                            </span></p>
                        </div>
                    </div>
                </div>

                <!-- Карточка услуги -->
                <div class="card" id="service_card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">Информация об услуге</h5>
                    </div>
                    <div class="card-body">
                        <div id="service-info">
                            <h6 id="service-name" class="card-subtitle mb-2">{{ order.service.service_name }}</h6>
                            <p class="card-text mb-2"><b>Стоимость:</b> 
                                <span id="service-price" class="text-success fw-bold">{{ order.service.price }}</span> руб.
                            </p>
                            <p class="card-text"><b>Описание:</b> <span id="service-description">
                                {{ order.service.description or 'Описание отсутствует' }}
                            </span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- JavaScript для динамического обновления информации -->
<script>
// Данные о клиентах и услугах
const customersData = {
    {% for customer in customers %}
    {{ customer.id }}: {
        name: "{{ customer.name }}",
        phone: "{{ customer.phone_number }}",
        email: "{{ customer.email or 'Не указан' }}",
        company: "{{ customer.company or 'Не указана' }}",
        birthdate: "{{ customer.date_of_birth.strftime('%d.%m.%Y') if customer.date_of_birth else 'Не указана' }}"
    },
    {% endfor %}
};

const servicesData = {
    {% for service in services %}
    {{ service.id }}: {
        name: "{{ service.service_name }}",
        price: "{{ service.price }}",
        description: "{{ service.description or 'Описание отсутствует' }}"
    },
    {% endfor %}
};

// Обработчики изменений в выпадающих списках
document.getElementById('customer_id').addEventListener('change', function() {
    const customerId = this.value;
    
    if (customerId && customersData[customerId]) {
        const customer = customersData[customerId];
        document.getElementById('customer-name').textContent = customer.name;
        document.getElementById('customer-phone').textContent = customer.phone;
        document.getElementById('customer-email').textContent = customer.email;
        document.getElementById('customer-company').textContent = customer.company;
        document.getElementById('customer-birthdate').textContent = customer.birthdate;
    }
});

document.getElementById('service_id').addEventListener('change', function() {
    const serviceId = this.value;
    
    if (serviceId && servicesData[serviceId]) {
        const service = servicesData[serviceId];
        document.getElementById('service-name').textContent = service.name;
        document.getElementById('service-price').textContent = service.price;
        document.getElementById('service-description').textContent = service.description;
    }
});

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Автоматически обновляем информацию при изменении выбора
    const customerSelect = document.getElementById('customer_id');
    const serviceSelect = document.getElementById('service_id');
    
    // Триггерим события change для обновления информации
    customerSelect.dispatchEvent(new Event('change'));
    serviceSelect.dispatchEvent(new Event('change'));
});
</script>
{% endblock %}